#include <SPI.h>
#include <LoRa.h>
#include <WiFiS3.h>
#include <ThingSpeak.h>

// Team Configuration - UPDATE THESE!
const int TEAM_ID = 1;  // Must match your transmitter team ID

// WiFi Credentials - GET FROM INSTRUCTOR
char ssid[] = "CampusWiFi";      // Your WiFi SSID
char pass[] = "Password123";     // Your WiFi password

// ThingSpeak Configuration - GET FROM INSTRUCTOR
unsigned long channelID = 123456;        // Your ThingSpeak channel ID
char* writeAPIKey = "YOUR_API_KEY_HERE"; // Your Write API Key

// Pin definitions
#define LORA_CS 10
#define LORA_RST 9
#define LORA_IRQ 2
#define BUZZER_PIN 8

// Variables
WiFiClient client;
unsigned long lastAlertTime = 0;
const unsigned long ALERT_COOLDOWN = 30000; // 30 seconds cooldown

void setup() {
  Serial.begin(9600);
  while (!Serial); // Wait for serial connection
  
  Serial.println("=== Security Gateway Receiver ===");
  Serial.print("Team: "); Serial.println(TEAM_ID);
  
  // Initialize components
  initializeBuzzer();
  
  if (!initializeLoRa()) {
    Serial.println("LoRa initialization failed!");
    while (true);
  }
  
  connectToWiFi();
  initializeThingSpeak();
  
  Serial.println("âœ… Gateway ready - listening for alerts...");
}

void initializeBuzzer() {
  pinMode(BUZZER_PIN, OUTPUT);
  digitalWrite(BUZZER_PIN, LOW);
  
  // Test buzzer on startup
  triggerBuzzer(1, 100);
}

bool initializeLoRa() {
  LoRa.setPins(LORA_CS, LORA_RST, LORA_IRQ);
  
  if (!LoRa.begin(915E6)) {
    return false;
  }
  
  LoRa.setSpreadingFactor(12);
  LoRa.setSignalBandwidth(125E3);
  LoRa.setCodingRate4(5);
  
  Serial.println("âœ… LoRa receiver initialized");
  return true;
}

void connectToWiFi() {
  Serial.print("Connecting to WiFi: ");
  Serial.println(ssid);
  
  WiFi.begin(ssid, pass);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 20) {
    delay(1000);
    Serial.print(".");
    attempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nâœ… WiFi connected!");
    Serial.print("IP Address: ");
    Serial.println(WiFi.localIP());
  } else {
    Serial.println("\nâŒ WiFi connection failed!");
  }
}

void initializeThingSpeak() {
  ThingSpeak.begin(client);
  Serial.println("âœ… ThingSpeak client initialized");
}

void loop() {
  // Check for incoming LoRa packets
  int packetSize = LoRa.parsePacket();
  if (packetSize) {
    handleIncomingPacket();
  }
  
  // Small delay to prevent overwhelming the serial monitor
  delay(100);
}

void handleIncomingPacket() {
  String packet = "";
  
  // Read packet data
  while (LoRa.available()) {
    packet += (char)LoRa.read();
  }
  
  // Get packet info
  int rssi = LoRa.packetRssi();
  float snr = LoRa.packetSnr();
  
  Serial.println("\n=== LoRa Packet Received ===");
  Serial.println("Data: " + packet);
  Serial.print("RSSI: "); Serial.println(rssi);
  Serial.print("SNR: "); Serial.println(snr);
  
  // Parse and process the alert
  if (packet.startsWith("TEAM")) {
    processAlertPacket(packet, rssi);
  }
}

void processAlertPacket(String packet, int rssi) {
  // Parse packet format: TEAMX:NODEY:TIMESTAMP:RSSI
  int teamStart = packet.indexOf("TEAM") + 4;
  int nodeStart = packet.indexOf("NODE") + 4;
  int timeStart = packet.indexOf(":", nodeStart) + 1;
  int rssiStart = packet.lastIndexOf(":") + 1;
  
  int teamID = packet.substring(teamStart, packet.indexOf(":")).toInt();
  int nodeID = packet.substring(nodeStart, timeStart - 1).toInt();
  unsigned long timestamp = packet.substring(timeStart, rssiStart - 1).toInt();
  
  // Verify it's from our team
  if (teamID == TEAM_ID) {
    handleSecurityAlert(nodeID, timestamp, rssi);
  } else {
    Serial.println("âš ï¸  Packet from different team - ignoring");
  }
}

void handleSecurityAlert(int nodeID, unsigned long timestamp, int rssi) {
  unsigned long currentTime = millis();
  
  // Cooldown check
  if (currentTime - lastAlertTime > ALERT_COOLDOWN) {
    Serial.println("ðŸš¨ SECURITY ALERT! ðŸš¨");
    Serial.print("Node: "); Serial.println(nodeID);
    Serial.print("Signal Strength: "); Serial.println(rssi);
    Serial.print("Timestamp: "); Serial.println(timestamp);
    
    // Local alert
    triggerBuzzer(3, 200);
    
    // Cloud logging
    sendToThingSpeak(nodeID, rssi);
    
    lastAlertTime = currentTime;
  } else {
    Serial.println("Alert ignored - within cooldown period");
  }
}

void triggerBuzzer(int beeps, int duration) {
  for (int i = 0; i < beeps; i++) {
    digitalWrite(BUZZER_PIN, HIGH);
    delay(duration);
    digitalWrite(BUZZER_PIN, LOW);
    delay(duration);
  }
}

void sendToThingSpeak(int nodeID, int rssi) {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("âŒ Cannot send to ThingSpeak - WiFi disconnected");
    return;
  }
  
  // Prepare data for ThingSpeak
  ThingSpeak.setField(1, nodeID);    // Field 1: Node ID
  ThingSpeak.setField(2, rssi);      // Field 2: Signal Strength
  ThingSpeak.setField(3, TEAM_ID);   // Field 3: Team ID
  
  Serial.println("Uploading to ThingSpeak...");
  
  int response = ThingSpeak.writeFields(channelID, writeAPIKey);
  
  if (response == 200) {
    Serial.println("âœ… ThingSpeak update successful!");
  } else {
    Serial.print("âŒ ThingSpeak update failed. Error: ");
    Serial.println(response);
  }
}

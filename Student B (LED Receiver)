#include <SPI.h>
#include <LoRa.h>

const int csPin = 10, resetPin = 9, irqPin = 2;
const int ledPin = 8;
bool ledState = false;

void setup() {
  Serial.begin(115200);
  pinMode(ledPin, OUTPUT);
  digitalWrite(ledPin, LOW);
  
  LoRa.setPins(csPin, resetPin, irqPin);
  if (!LoRa.begin(868E6)) {
    Serial.println("LoRa init failed!");
    while (1);
  }
  
  Serial.println("LED Controller Ready");
  Serial.println("Waiting for toggle commands...");
}

void loop() {
  int packetSize = LoRa.parsePacket();
  
  if (packetSize) {
    String command = "";
    while (LoRa.available()) {
      command += (char)LoRa.read();
    }
    
    if (command == "TOGGLE_LED") {
      ledState = !ledState;
      digitalWrite(ledPin, ledState);
      
      Serial.print("LED ");
      Serial.println(ledState ? "ON" : "OFF");
      Serial.print("RSSI: ");
      Serial.println(LoRa.packetRssi());
    }
  }
}

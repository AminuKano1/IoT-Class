# realtime_camera.py
print("=== Real-time Object Detection ===")
print("Starting camera...")

import cv2
import time
from object_detector import TFLiteObjectDetector, draw_detections

# Initialize detector
print("Loading AI model...")
detector = TFLiteObjectDetector('models/detect.tflite', 'models/labelmap.txt')

# Initialize camera
print("Opening camera...")
camera = cv2.VideoCapture(0)

# Set camera resolution
camera.set(cv2.CAP_PROP_FRAME_WIDTH, 640)
camera.set(cv2.CAP_PROP_FRAME_HEIGHT, 480)

# Wait for camera to start
time.sleep(2)

print("Camera ready!")
print("Press 'q' to quit")
print("Press 's' to save current frame")

frame_count = 0
start_time = time.time()
fps = 0

try:
    while True:
        # Read camera frame
        ret, frame = camera.read()
        if not ret:
            print("Failed to get camera frame")
            break
        
        # Run object detection every 3 frames (for better performance)
        if frame_count % 3 == 0:
            detections, inference_time = detector.detect_objects(frame, min_confidence=0.5)
        
        # Draw detections on frame
        if detections:
            frame = draw_detections(frame, detections)
        
        # Calculate FPS
        frame_count += 1
        if frame_count % 10 == 0:
            end_time = time.time()
            fps = 10 / (end_time - start_time)
            start_time = end_time
        
        # Display FPS and object count
        cv2.putText(frame, f"FPS: {fps:.1f}", (10, 30), 
                   cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 255, 0), 2)
        cv2.putText(frame, f"Objects: {len(detections)}", (10, 60), 
                   cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 255, 0), 2)
        cv2.putText(frame, "Press 'q' to quit", (10, 90), 
                   cv2.FONT_HERSHEY_SIMPLEX, 0.5, (255, 255, 255), 1)
        
        # Show frame
        cv2.imshow('Real-time Object Detection', frame)
        
        # Check for key presses
        key = cv2.waitKey(1) & 0xFF
        if key == ord('q'):
            print("Quitting...")
            break
        elif key == ord('s'):
            # Save current frame
            timestamp = int(time.time())
            filename = f"capture_{timestamp}.jpg"
            cv2.imwrite(filename, frame)
            print(f"Frame saved as {filename}")

except KeyboardInterrupt:
    print("Stopping...")

finally:
    # Clean up
    camera.release()
    cv2.destroyAllWindows()
    print("Camera released. Program ended.")

print("Thank you for using the object detector!")
